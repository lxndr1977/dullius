---
// Gallery.astro
import { ChevronLeft, ChevronRight, X } from "@lucide/astro";

const images = [
  { src: "/images/short-1.jpg", alt: "Apresentacao de ballet no palco" },
  { src: "/images/short-1.jpg", alt: "Recital de jazz" },
  { src: "/images/short-1.jpg", alt: "Performance de danca contemporanea" },
  { src: "/images/short-1.jpg", alt: "Alunos de ballet no palco" },
  { src: "/images/short-1.jpg", alt: "Performance de dancas urbanas" },
  { src: "/images/short-1.jpg", alt: "Solo de ballet" },
];
---

<section id="galeria" class="bg-foreground py-24 lg:py-32">
  <div class="mx-auto max-w-7xl px-6">
    <div
      class="mb-16 flex flex-col items-center gap-6 text-center md:flex-row md:items-end md:justify-between md:text-left"
    >
      <div>
        <p class="text-sm font-semibold uppercase tracking-widest text-red-700">
          Galeria
        </p>
        <h2
          class="mt-3 text-4xl text-zinc-900 md:text-5xl lg:text-6xl font-medium tracking-tighter text-balance"
        >
          Conheça a nossa escola
        </h2>
        <p
          class="mt-4 max-w-xl text-lg xl:text-xl text-zinc-700 leading-relaxed"
        >
          Um espaço pensado para oferecer conforto, segurança e a melhor
          experiência para alunos e famílias.
        </p>
      </div>

      <div class="flex gap-2">
        <button
          type="button"
          data-scroll-left
          class="flex h-12 w-12 items-center justify-center rounded-full border border-zinc-200 text-background transition-colors hover:bg-background/10 disabled:opacity-30 disabled:cursor-not-allowed"
          aria-label="Slide anterior"
          disabled
        >
          <ChevronLeft class="h-5 w-5" />
        </button>
        <button
          type="button"
          data-scroll-right
          class="flex h-12 w-12 items-center justify-center rounded-full border border-zinc-200 text-background transition-colors hover:bg-background/10 disabled:opacity-30 disabled:cursor-not-allowed"
          aria-label="Proximo slide"
        >
          <ChevronRight class="h-5 w-5" />
        </button>
      </div>
    </div>
  </div>

  <div
    data-gallery-scroll
    class="scrollbar-hide flex gap-4 overflow-x-auto px-6 lg:px-[calc((100vw-80rem)/2+1.5rem)]"
    role="region"
    aria-label="Galeria de fotos"
  >
    {
      images.map((img, index) => (
        <button
          type="button"
          data-lightbox-trigger
          data-index={index}
          class="group relative aspect-[3/4] w-[42vw] flex-shrink-0 overflow-hidden rounded-2xl md:w-[30vw] lg:w-[22vw]"
        >
          <img
            src={img.src}
            alt={img.alt}
            class="absolute inset-0 h-full w-full object-cover transition-transform duration-700 group-hover:scale-105"
          />
          <div class="absolute inset-0 bg-zinc-900/20 transition-all duration-300 group-hover:bg-foreground/20" />
        </button>
      ))
    }
  </div>

  <div class="mx-auto mt-8 flex justify-center gap-2" data-dots-container>
    {
      images.map((_, i) => (
        <button
          type="button"
          data-dot
          data-index={i}
          class={`h-2 rounded-full transition-all duration-300 ${
            i === 0
              ? "w-8 bg-accent"
              : "w-2 bg-background/30 hover:bg-background/50"
          }`}
          aria-label={`Ir para foto ${i + 1}`}
        />
      ))
    }
  </div>

  <div
    data-lightbox
    class="fixed inset-0 z-50 hidden items-center justify-center bg-zinc-900/90 p-6 backdrop-blur-sm"
    role="dialog"
    aria-label="Visualizar imagem"
  >
    <button
      type="button"
      data-lightbox-prev
      class="absolute left-4 top-1/2 -translate-y-1/2 rounded-full bg-zinc-800 p-3 text-zinc-300 transition-colors hover:bg-background/20 md:left-8"
      aria-label="Foto anterior"
    >
      <ChevronLeft class="h-6 w-6" />
    </button>

    <button
      type="button"
      data-lightbox-close
      class="absolute right-6 top-6 rounded-full bg-zinc-800 p-3 text-zinc-300 transition-colors hover:bg-background/20"
      aria-label="Fechar"
    >
      <X class="h-6 w-6" />
    </button>

    <div
      class="relative h-[80vh] w-full max-w-4xl"
      data-lightbox-image-container
    >
      <img
        data-lightbox-image
        src=""
        alt=""
        class="absolute inset-0 h-full w-full object-contain"
      />
    </div>

    <button
      type="button"
      data-lightbox-next
      class="absolute right-4 top-1/2 -translate-y-1/2 rounded-full bg-zinc-800 p-3 text-zinc-300 transition-colors hover:bg-background/20 md:right-8"
      aria-label="Proxima foto"
    >
      <ChevronRight class="h-6 w-6" />
    </button>

    <div class="absolute bottom-6 left-1/2 -translate-x-1/2">
      <p class="text-sm text-background/70" data-lightbox-counter>
        1 / {images.length}
      </p>
    </div>
  </div>
</section>

<style>
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
</style>

<script define:vars={{ images }}>
  let activeIndex = 0;
  let lightboxIndex = null;

  const scrollContainer = document.querySelector("[data-gallery-scroll]");
  const scrollLeftBtn = document.querySelector("[data-scroll-left]");
  const scrollRightBtn = document.querySelector("[data-scroll-right]");
  const dots = document.querySelectorAll("[data-dot]");
  const lightboxTriggers = document.querySelectorAll("[data-lightbox-trigger]");
  const lightbox = document.querySelector("[data-lightbox]");
  const lightboxImage = document.querySelector("[data-lightbox-image]");
  const lightboxCounter = document.querySelector("[data-lightbox-counter]");
  const lightboxClose = document.querySelector("[data-lightbox-close]");
  const lightboxPrev = document.querySelector("[data-lightbox-prev]");
  const lightboxNext = document.querySelector("[data-lightbox-next]");

  // Scroll functionality
  function checkScroll() {
    if (!scrollContainer) return;

    const canScrollLeft = scrollContainer.scrollLeft > 4;
    const canScrollRight =
      scrollContainer.scrollLeft <
      scrollContainer.scrollWidth - scrollContainer.clientWidth - 4;

    scrollLeftBtn.disabled = !canScrollLeft;
    scrollRightBtn.disabled = !canScrollRight;

    const cardWidth = scrollContainer.clientWidth * 0.42;
    const gap = 16;
    const idx = Math.round(scrollContainer.scrollLeft / (cardWidth + gap));
    activeIndex = Math.min(idx, images.length - 1);

    updateDots();
  }

  function scroll(direction) {
    if (!scrollContainer) return;
    const cardWidth = scrollContainer.clientWidth * 0.42;
    const gap = 16;
    const distance = cardWidth + gap;
    scrollContainer.scrollBy({
      left: direction === "left" ? -distance : distance,
      behavior: "smooth",
    });
  }

  function scrollToIndex(index) {
    if (!scrollContainer) return;
    const cardWidth = scrollContainer.clientWidth * 0.42;
    const gap = 16;
    scrollContainer.scrollTo({
      left: index * (cardWidth + gap),
      behavior: "smooth",
    });
  }

  function updateDots() {
    dots.forEach((dot, i) => {
      if (i === activeIndex) {
        dot.classList.remove("w-2", "bg-background/30");
        dot.classList.add("w-8", "bg-accent");
      } else {
        dot.classList.remove("w-8", "bg-accent");
        dot.classList.add("w-2", "bg-background/30");
      }
    });
  }

  // Lightbox functionality
  function openLightbox(index) {
    lightboxIndex = index;
    updateLightbox();
    lightbox?.classList.remove("hidden");
    lightbox?.classList.add("flex");
    document.body.style.overflow = "hidden";
  }

  function closeLightbox() {
    lightbox?.classList.add("hidden");
    lightbox?.classList.remove("flex");
    document.body.style.overflow = "";
    lightboxIndex = null;
  }

  function updateLightbox() {
    if (lightboxIndex === null) return;
    const img = images[lightboxIndex];
    if (lightboxImage) {
      lightboxImage.src = img.src;
      lightboxImage.alt = img.alt;
    }
    if (lightboxCounter) {
      lightboxCounter.textContent = `${lightboxIndex + 1} / ${images.length}`;
    }
  }

  function nextLightbox() {
    if (lightboxIndex === null) return;
    lightboxIndex = lightboxIndex === images.length - 1 ? 0 : lightboxIndex + 1;
    updateLightbox();
  }

  function prevLightbox() {
    if (lightboxIndex === null) return;
    lightboxIndex = lightboxIndex === 0 ? images.length - 1 : lightboxIndex - 1;
    updateLightbox();
  }

  // Event listeners
  scrollLeftBtn?.addEventListener("click", () => scroll("left"));
  scrollRightBtn?.addEventListener("click", () => scroll("right"));
  scrollContainer?.addEventListener("scroll", checkScroll, { passive: true });
  window.addEventListener("resize", checkScroll);

  dots.forEach((dot) => {
    dot.addEventListener("click", () => {
      const index = parseInt(dot.getAttribute("data-index") || "0");
      scrollToIndex(index);
    });
  });

  lightboxTriggers.forEach((trigger) => {
    trigger.addEventListener("click", () => {
      const index = parseInt(trigger.getAttribute("data-index") || "0");
      openLightbox(index);
    });
  });

  lightboxClose?.addEventListener("click", closeLightbox);
  lightbox?.addEventListener("click", closeLightbox);
  lightboxPrev?.addEventListener("click", (e) => {
    e.stopPropagation();
    prevLightbox();
  });
  lightboxNext?.addEventListener("click", (e) => {
    e.stopPropagation();
    nextLightbox();
  });

  // Prevent closing when clicking on image
  document
    .querySelector("[data-lightbox-image-container]")
    ?.addEventListener("click", (e) => {
      e.stopPropagation();
    });

  // Keyboard navigation
  document.addEventListener("keydown", (e) => {
    if (lightboxIndex === null) return;
    if (e.key === "Escape") closeLightbox();
    if (e.key === "ArrowLeft") prevLightbox();
    if (e.key === "ArrowRight") nextLightbox();
  });

  // Initial check
  checkScroll();
</script>
